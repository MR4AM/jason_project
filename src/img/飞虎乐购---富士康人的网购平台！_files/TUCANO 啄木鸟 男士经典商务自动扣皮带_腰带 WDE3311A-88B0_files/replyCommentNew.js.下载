/*
 * 回复评论js
 * autor: xintong wenjie
 * Date: 2012-04-25
 * Revision:1.0
 */
(function($){  
    
    //控制输入字数的文本方法	
	function chackTextarea(obj,maxnum,minnum,objTip){
	    //var newvalue = obj.val().replace(/[^\x00-\xff]/g, "**"); 
	    //var minnum0=parseInt(minnum/2);
	    //var maxnum0=parseInt(maxnum/2);
	    var newvalue = obj.val(); 
	    var minnum0=parseInt(minnum);
	    var maxnum0=parseInt(maxnum);
	    if(newvalue.length>0){
		    if (newvalue.length > maxnum) {
				    var len=parseInt(newvalue.length - maxnum);
				    objTip.html("<span class='m_form_errhint'>已超出" +len+"个字</span>");
		    }else if(newvalue.length < minnum){
			        objTip.html(" <span class='m_form_errhint'>最少输入" +minnum0+"个字</span>");
		    }else{
			    var len=parseInt(maxnum-newvalue.length);
			    objTip.html("还可以输入<em>" +len+"</em>个字");
			    objTip.css("color","#999");
			    obj.css("borderColor","#ccc");
		    }
	    }else{
		    objTip.html("还可以输入<em>" +maxnum0+"</em>个字");
		    objTip.css("color","#999");
			obj.css("borderColor","#ccc");
	    }
    }
	//控制输入字数的文本显示焦点事件	
	$.fn.controlInput=function(){
          var timeout;
          var defText= "请您填写对此评论的意见或观点，例如评论给您带来的帮助，或补充描述内容等。";
             
		  $(this).focus(function(){	
		      var textarea = $(this); 
              var domtextarea =	textarea[0]; 
              var TipsShow = $(this).next("span");     
		      if(domtextarea!=null&& domtextarea.value==defText)
		      {
			     domtextarea.value = "";
			     domtextarea.style.color = "#000";
		      }    
		      timeout=setInterval(function(){chackTextarea(textarea,500,4,TipsShow);},100);   //修改为最多输入500个汉字 			
		  })
		  
		 $(this).blur(function (){ 
		      var textarea = $(this); 
              var domtextarea =	textarea[0];     
	          if(domtextarea!=null&& domtextarea.value=="")
	          {
	             domtextarea.value = defText;
			     domtextarea.style.color = "#ccc";      
		      }
			  clearInterval(timeout);
		 })	 
		  
	  }	
     //提交回复评论
    $.fn.SubmitReplyComm = function(fun){
		    $(this).click(function(){	//点击触发事件	  
		        var defText= "请您填写对此评论的意见或观点，例如评论给您带来的帮助，或补充描述内容等。";  	
		        var commId=$(this).attr("ref");
		        var replyContent=$(this).parent().parent().children(".txtarea").val();	
		        var objectThis=$(this);	       
		       // var convertContent= replyContent.replace(/[^\x00-\xff]/g, "**"); //将汉字转换为**，进行验证输入的字数
		        if((replyContent.length>3)&&(replyContent.length<501)&&(replyContent!=defText)){//最少输入4个字，最多输入500个字
		            replyContent = escape(replyContent);
		            objectThis.prop('disabled',true);    
		            //回复内容字数必须大于等于4,且小于等于250,且回复内容不是默认的内容
		             $.ajax({
                              url: "/PublicAjax/Comment/ReplyComment.ashx",
		                      cache: false,
		                      data:{commonId:commId,replyContent:replyContent},
		                      dataType:"text",
		                      error : function(){			                        
	                                objectThis.prop('disabled',false);
		                      },
		                      success: function(json){
		                        var data = eval('(' + json + ')');
	                              if(data.result==true ){                           
                                        objectThis.parent().parent().children(".txtarea").empty();
                                        objectThis.parent().parent().children(".txtarea").val("");
                                        var innhtml ='<div class="content">';
                                        innhtml+='<p class="title">您的回复已经成功提交！</p> ';			                                
                                        innhtml+='  <p class="des">审核通过后将显示于页面，谢谢您的参与！</p>  ';
                                        innhtml+=' </div> ';
                                        innhtml+=' <div class="m_minWin_bdfd">本窗口将在2秒后自动关闭</div>  ';
                                        showDialog({id : 'replayCommCloseWin',currClass : 'ms_minWin_Succ',content : innhtml, title : '回复成功'});			                                
                                        setTimeout(function(){hideDialog({id : 'replayCommCloseWin'});},2000);//阴影效果 
	      			                    fun();   //回复成功后关闭下拉框
	      			                        
	      		                  }else {
	      		                    if(data.result=="dataerror"){
								        alert("您输入了特殊字符,请检查您的输入！");
								      }else{
								        alert("回复评论失败！")
								      }				      		                    
	      		                  }
                                objectThis.prop('disabled',false);
				                  }
	                  })
		       
		       }
    		
           });
	};
	
	//关闭回复评论
	$.fn.closeReplyComm=function(){
	        $(this).click(function(){	//点击关闭按钮触发事件			  	
	    	  // $(this).closest(".reply").hide();	
	    	  $(this).closest(".nonereplycommcss").hide();		       	
	        });
    }
	
})(jQuery);

/*
 * 验证用户是否登录，是否可以顶嘘，更新顶嘘数量并保存一条记录
 * autor: mafang
 * Date: 2012-04-24
 * Revision:1.0
 */
 
function applaud(obj,pdtNo,commentId,isGood){

	$.ajax({url:'/PublicAjax/CheckLogin.ashx?pidno=' + pdtNo + '&random='+Math.random(),dataType:'text',success: function(data){
	   var json = eval('(' + data + ')');	 //验证是否登录  	
	   if(json.isLogin==false){//没有登录     
			 self.location.href = json.loginUrl;
	   
	   }else{
		  $.ajax({url:'/PublicAjax/Comment/ApplaudIsOrNot.ashx?commentId='+commentId+'&isGood='+isGood+'&random='+Math.random(),dataType:'text',success: function(data){
		        var json = eval('(' + data + ')');//判断用户当天是否已有顶嘘               
				if(json.result==true){ 
				    $(obj).html(parseInt($(obj).text())+1);
			    }
		  }});
	   }
	}})
}

 function showAllComment(type, pageSize, panel,pageIndexFirst){
        //var intmomentId = $().val();
        var productNo = window.itemInfo.productNo;
        commentId = request("cId");
        usercomment=request("Ttype");      //获取Ttype标志，用来区分是否评论定位，为空则为需要定位的商品
        var pageObject = $(panel).find(".ui_pagewrap");            
        var oCommentList = $(panel).find(".ui_commentList");
            
        var pageIndex =  1;
        if(""!=commentId &&""==usercomment &&pageIndexFirst=="all"){
            $.ajax({
              url: "/PublicAjax/Comment/SeeComment.ashx?pidno="+productNo+'&cId='+commentId,
              cache: false,
              dataType:'text',
              async:false,
              success: function(json){
                var data = eval('(' + json + ')');
                pageIndex = data.pageIndex;
              }
            });
        }
        var commentTpl = '<div class="ui_commentList_item">\
                            	<div class="user">\
                                    <p class="user_status <#=UserLevelIcon#>"><#=USERLEVEL#></p>\
                                    <p class="user_name"><#=NICKNAME#></p>\
                                    <p class="user_status_name">\
                                        <#=USERLEVEL#>会员\
                                        <#=HASBUY#>\
                                    </p>\
                                </div>                                \
                                <div class="content" data-comment-id=<#=ID#>>\
                                    <div class="content_hd">\
                                        <span class="comment_title"><#=COMMENTTITLE#></span>\
                                        <#=PRODUCTGRADES#>\
                                        <div class="time"><#=CREATEDDT#></div>\
                                    </div>\
                                    <div class="content_bd"><#=PDTCOMMENT#></div>\
                                    <div class="content_fd">\
                                        <a class="ui_form_btnSmall replyComm" target="_self" href="javascript:" id="m_reply">回 复</a>\
                                        <div class="agreeCon">\
                                              <a class="agree" onclick="applaud(this,\'<#=PRODUCTNO#>\',<#=ID#>,1)" href="javascript:;"><#=GOODCOUNT#></a>\
                                            <a class="disagree" onclick="applaud(this,\'<#=PRODUCTNO#>\',<#=ID#>,0)" href="javascript:;"><#=BADCOUNT#></a>\
                                        </div>\
                                    </div>\
                                    <div class="replys nonereplycommcss" style="display: none;">\
                                    <div class="reply_icon">\
                                    </div>\
                                    <div class="m_reply">\
                                        <div class="m_comment_post_name">\
                                            <a class="m_minWin_close closereplyCommBtn" target="_self" hidefocus="true" href="javascript:">\
                                                关闭</a>\
                                        </div>\
                                        <div class="m_comment_post_content">\
                                            <textarea class="txtarea">请您填写对此评论的意见或观点，例如评论给您带来的帮助，或补充描述内容等。</textarea>\
                                            <span class="m_comment_post_inputTitle_tips">还可以输入 <em>500</em> 字，最少输入4个字 </span>\
                                            <p class="m_comment_post_op">\
                                                <input id="minWinPressNamebtn" class="m_form_btnSmall submitReplyComm" type="button"\
                                                    onmouseout="$(this).removeClass(\'m_form_btnBig_hover\');" onmouseover="$(this).addClass(\'m_form_btnBig_hover\');"\
                                                    value="提交回复" ref=<#=ID#>>\
                                            </p>\
                                        </div>\
                                    </div>\
                                </div>\
                                    \
                                    <div class="reply_op">                                    	\
                                        <div class="reply_icon"></div>\
                                        <a class="close" target="_self" hidefocus="true" href="javascript:void(0)">关闭</a>                                                 \
                                         \
                                         <div class="txtareaCon">\
                                            <textarea class="txtarea">请您填写对此评论的意见或观点，例如评论给您带来的帮助，或补充描述内容等。\
                                            </textarea>\
                                         </div>\
                                         <div class="btn">                                                 \
                                            <span class="numhint">还可以输入<em>500</em>字，最少输入4个字</span>\
                                            <a class="ui_form_btnSmall" target="_self" href="javascript:void(0)">提交回复</a>\
                                         </div>                                             \
                                    </div>\
                                    <#=replies#>\
                                </div>\
                            </div>';
        var replyCommentTpl = '<div class="<#=reply_class#>">\
                                            <div class="<#=reply_class#>_hd">\
												<#=layer#>\
                                                <div class="name"><#=name#> </div>\
                                                <div class="time"><#=CREATEDDT#></div>\
                                            </div>\
                                            <div class="<#=reply_class#>_bd">\
                                                <span class="lbl">回复：</span>\
                                                <p class="txt"><#=REPLYCONTENT#></p>\
                                            </div>\
                                        </div>';
        var commentFooterTpl = '<p class="vi_comment_access"><a target="_blank" href="/Pages/ProductShow/AllComment.aspx?pidno=<#=productNo#>&type=<#=type#>">查看全部<#=count#>条评论</a>\
	                        <a id="IwantCommentId_re" href="javascript:;" ref="/Pages/ProductShow/ReviewComment.aspx?pidno=<#=productNo#>">我要评论</a>\
                        </p>';
        var replyPageTpl = '<div class="ui_page"><div class="ui_pagewrap"><#=pages#></div></div>';
        var userLevels = ['','银虎','金虎','白金虎','钻石虎'];
        var userLevelIcons = ['','user_status_yinhu','user_status_jinhu','user_status_baijin','user_status_zuanshi'];
        var PageBound = function(pages, page, count) {
            page=Number(page);
            pages=Number(pages);
            count=Number(count);
	        var me = this, NUM = 3, HF = 1, i, arr = [], pres = page - HF, nexts =page + HF, min = 1, max = pages, pre, next;
	        pre = page - 1 < 1 ? 1 : page - 1;
	        next = page + 1 > pages ? pages : page + 1;
	        if (pages < NUM) {
	            for (i = 1; i <= pages; i++) {
	                arr.push(i);
	            }
	            return {
	                min: min, max: max, pres: pres, nexts: nexts, pages: pages, page: page, loops: arr, count: count, pre: pre, next: next
	            };
	        }
            

	        if (pres <= 0) {
	            pres = 1;
	        }
	        nexts = nexts > pages ? pages : nexts;
	       
	        for (i = pres; i <= nexts; i++) {
	            arr.push(i);
	        }

	        return {
	            min: min, max: max, pres: pres, nexts: nexts, pages: pages, page: page, loops: arr, count: count, pre: pre, next: next, first: 1, last: pages
	        };
	    };
	    
	    function getPage(pageCount,pageIndex,recordCount){
	        var pageBound = new PageBound(pageCount, pageIndex, recordCount);
	        var _pageArr = [];
            for (j = 0, loopLen = pageBound.loops.length; j < loopLen; j++) {
                var _j = pageBound.loops[j];
                currPageStr = pageBound.page == _j ? ' class="curr" ' : '';
                eventStr = ' page="' + _j + '" ';
                _pageArr.push('<a href="javascript:;"' + currPageStr + eventStr + '>' + _j + '</a>');
            }
            _pageArr = _pageArr.join('');
            if (typeof pageBound.first != 'undefined' && pageBound.loops[0] != 1) {
                _pageArr = '<a href="javascript:;" page="' + pageBound.first + '">' + pageBound.first + '</a>' + '<a href="javascript:;" page="' + pageBound.pres + '">...</a>' + _pageArr;
            }
            if (typeof pageBound.last != 'undefined' && pageBound.loops[loopLen - 1] != pageBound.last) {
                _pageArr = _pageArr + '<a href="javascript:;" page="' + pageBound.nexts + '">...</a>' + '<a href="javascript:;" page="' + pageBound.last + '">' + pageBound.last + '</a>';
            }
            var preClass=pageIndex==1?' class="pre dis"':' class="next"';
            var nexClass=pageIndex==pageCount?' class="pre dis"':'class="next"';
            _pageArr='<a '+preClass+' href="javascript:;" page="pre">上一页</a>'+_pageArr;
            _pageArr+='<a '+nexClass+' href="javascript:;" page="next">下一页</a>';   
            _pageArr += '<span class="num">共<em class="total" totalnum='+pageCount+'>'+pageCount+'</em>页</span><span class="change">\
                                                    ，到第\
                                                    <input type="text" class="txt">页\
                                                    <input type="button" class="btn" value="确定">\
                                                </span>';
                                          
            return _pageArr;
	    };
	    
	    function showReplyCommentList(recordCount,replies,pageIndex){
           var replyContent = [];
           pageIndex = pageIndex || 1;
           replyContent.push('<div class="reply_icon"></div>');
           $.each(replies,function(i){
                if (this.ISADMINREPLY == 1)
                {
                    this.name = window.itemInfo.isMerchant ? '掌柜回复' : '飞虎乐购';
                    this.reply_class = 'reply_fh';
                    this.layer = '';
                }
                else{
                    this.name = this.NICKNAME;
                    this.reply_class = 'reply_user';
                    this.layer = '<span class="layer">'+(recordCount-this.RM+1)+'楼</span>';
                }
                replyContent.push(unescape(jsTpl(replyCommentTpl, this, true)));
            });                    
            var pageCount = Math.ceil(recordCount / 4);
            if (pageCount > 1){
                var pageContent = getPage(pageCount,pageIndex,recordCount);
                replyContent.push(unescape(jsTpl(replyPageTpl, {pages : pageContent}, true)));                            
            }
            return replyContent.join('');
	    }
	    
        function showCommentList(data,panel,pageIndex){  
            var html = [];      
            $.each(data.data, function(i) {
                var oComment = this;
                var commentid = this.ID;                
                this.PRODUCTNO = productNo;
                if(data.data[i].PRODUCTGRADE!='')
                {
                    this.HASBUY='<span class="bought">已购</span>';
                    this.PRODUCTGRADES=showGrade(data.data[i].PRODUCTGRADE);
                }
                else
                {
                    this.HASBUY='';
                    this.PRODUCTGRADES='';
                }
                this.UserLevelIcon = userLevelIcons[this.USERLEVEL];
                this.USERLEVEL = userLevels[this.USERLEVEL];
                var replies = data.replies['' + commentid + ''];
                var strReply = '';
                if (replies && replies.length > 0){
                    strReply = showReplyCommentList(oComment.replyCount, replies);
                    this.replies ='<div class="reply" >'+ strReply+'</div>';
                }
                else{
                    this.replies='';
                }
                
           
                
                html[i] = unescape(jsTpl(commentTpl, this, true));
            });
            
            html.push(unescape(jsTpl(commentFooterTpl, {productNo : productNo,count : data.count, type : type}, true)));
            var pageCount = Math.ceil(data.count / 5);
            var pageContent = getPage(pageCount,pageIndex,data.count);
            
            oCommentList.html(html.join(""));
            $(pageObject).html(pageContent);
            
            
            //评论页码事件绑定
            $(pageObject).unbind("click");
            $(pageObject).click(function(e){ 
                var othis = $(e.target);
                var page = othis.attr('page');
                var indexNum=pageNum(othis,page);
                if(indexNum)
                {
                    showComment(indexNum);  
                }
            }); 
            $(pageObject).find(".btn").unbind("click");
            $(pageObject).find(".btn").click(function(){
                    var othis = $(this);
                    var page = othis.prev(".txt").val();
                    var indexNum=pageNum(othis,page);
                if(indexNum)
                {
                    showComment(indexNum);  
                } 
             });
             
            //评论回复中的页码事件绑定 
            oCommentList.find(".ui_pagewrap").unbind("click");    
            oCommentList.find(".ui_pagewrap").click(function(e){               
                var othis = $(e.target);
                var page = othis.attr('page');
                
                var indexNum=pageNum(othis,page);
                if(indexNum)
                {
                    showReplyCommentPage(othis,indexNum);
                }                
            });
            oCommentList.find(".ui_pagewrap .btn").unbind("click");    
            oCommentList.find(".ui_pagewrap .btn").click(function(e){     
                var othis = $(this);
                var page = othis.prev(".txt").val();
                if(!page)
                {
                    return;
                }
                showReplyCommentPage(othis,page);                
            }); 
            
            $('.replyComm').CheckNickName(function(obj){
				$(obj).parent("div").next("div").show("fast");
			 });
			 //提交回复内容      
			$('.submitReplyComm').SubmitReplyComm(function(){
				$('.replyComm').closest(".content_fd").siblings(".nonereplycommcss").slideUp();            
			});
			//对输入回复文本进行控制
			$('.txtarea', oCommentList).controlInput();
			 //控制回复评论页的关闭按钮
			$('.closereplyCommBtn').closeReplyComm();   
		    //绑定页面中产品编号下的我要评论按钮,进行昵称以及登录验证
            $("#IwantCommentId_re").CheckNickName(function(obj){    
                 window.location.href=$(obj).attr("ref");    
            });
        }
        
        function pageNum(othis,page)
        {
            var indexNum=Number(page);
            var cuurNum=Number(othis.parent().find(".curr").attr('page'));
            var totalNum=Number(othis.parent().parent().find(".num .total").attr('totalnum'));
            
            if (page=='pre')
            {
                if(cuurNum==1) {
                    alert('已经是第一页');
                    return false;
                }
                else{
                    indexNum= cuurNum-1;
                }
            }
            if(page=="next")
            {
                if(cuurNum==totalNum){
                    alert('已经是最后一页');
                    return false;
                }
                else{ 
                    indexNum=cuurNum+1;
                }
            }
//            alert(indexNum+"@"+totalNum);
            if(indexNum<1 || indexNum>totalNum)
            {
                alert('页码超出范围');
                return false;
            }
            return indexNum;
        }
        
        function showReplyCommentPage(othis,pageIndex){   
                var parent = othis.parents('.content');
                var commentid= parent.attr('data-comment-id');  
                if (pageIndex && commentid){
                    var url = '/PublicAjax/Comment/ProductCommentReply.ashx?random='+Math.random();
                    $.ajax({
                        url : url,
                        data : {commentId : commentid, pageSize : 4 ,pageIndex : pageIndex},
                        dataType : 'text',
                        success : function(json){
                        json=json.replace(/\\/g,"");
                        var jsonData = eval('(' + json + ')');
                           var html = showReplyCommentList(jsonData.count,jsonData.data,pageIndex);
                           parent.find('.reply').html(html);
                           
                            $("#commentListId_"+type).find(".ui_pagewrap").click(function(e){               
                                var othis = $(e.target);
                                var page = othis.attr('page');
                                
                                var indexNum=pageNum(othis,page);
                                if(indexNum)
                                {
                                    showReplyCommentPage(othis,indexNum);
                                }    
                            }); 
                            
                            $("#commentListId_"+type).find(".ui_pagewrap .btn").click(function(e){     
                                var othis = $(this);
                                var page = othis.prev(".txt").val();
                                var indexNum=pageNum(othis,page);
                                if(indexNum)
                                {
                                    showReplyCommentPage(othis,indexNum);
                                }                  
                            });   
                        }
                    });                    
                }            
        }
        
        function showComment(pageIndex)
        {
            var url = '/PublicAjax/Comment/ProductComment.ashx?random='+Math.random()+'&commentId='+commentId+'&Ttype='+usercomment;
            $.ajax({
                url : url,
                dataType : 'text',
                type : "GET",
                data : {'pidno':productNo,'type':type , pageIndex : pageIndex , pageSize : 5},
                success : function(json){
                var data = eval('(' + json + ')');
                    showCommentList(data,panel,pageIndex);
                    if(data.result){
                        $(pageObject).addClass("ui_pagewrap");
                    }
                    else{
                        $("#commentListId_"+type).prepend(data.reply); 
                        $(pageObject).parent().hide();
                        $(pageObject).removeClass();
                    }
                    
                }
            });

        }
        showComment(pageIndex);
        return;
 }
 
 function showGrade(grade){
        var class_type;
        var fenshu;
        var taidu;
        var htmlTemplate = '';
        if(grade>4.5&&grade<=5.0){
            class_type = "m_score m_score5d";
            fenshu ="5.0";
            taidu = "满意";
        }else if(grade>4.0&&grade<=4.5){
            class_type = "m_score m_score4d5";
            fenshu ="4.5";
            taidu = "满意";
        }else if(grade>3.5&&grade<=4.0){
            class_type = "m_score m_score4d";
            fenshu ="4.0";
            taidu = "满意";
        }else if(grade>3.0&&grade<=3.5){
            class_type = "m_score m_score3d5";
            fenshu ="3.5";
            taidu = "满意";
        }else if(grade>2.5&&grade<=3.0){
            class_type = "m_score m_score3d";
            fenshu ="3.0";
            taidu = "一般";
        }else if(grade>2.0&&grade<=2.5){
            class_type = "m_score m_score2d5";
            fenshu ="2.5";
            taidu = "一般";
        }else if(grade>1.5&&grade<=2.0){
            class_type = "m_score m_score2d";
            fenshu ="2.0";
            taidu = "一般";
        }else if(grade>1.0&&grade<=1.5){
            class_type = "m_score m_score1d5";
            fenshu ="1.5";
            taidu = "不满意";
        }else if(grade<=1.0){
            class_type = "m_score m_score1d";
            fenshu ="1.0";
            taidu = "不满意";
        }
         htmlTemplate += '<div class="sorce">';
         htmlTemplate += '<span class="ui_psorce" title="'+fenshu+'" >';
         htmlTemplate += '<em style ="width:'+fenshu*20+'%"></em>';
         htmlTemplate += '</span>';
         htmlTemplate += '<span class="num"><em>'+fenshu+'</em>分</span>';
         htmlTemplate += '<span class="satisfy">'+taidu+'</span>';
         htmlTemplate += '</div>';
         return htmlTemplate;
 }
 //从url中取值
 function request(paras)
    { 
        var url = location.href; 
        var paraString = url.substring(url.indexOf("?")+1,url.length).split("&"); 
        var paraObj = {} 
        for (i=0; j=paraString[i]; i++){ 
        paraObj[j.substring(0,j.indexOf("=")).toLowerCase()] = j.substring(j.indexOf("=")+1,j.length); 
        } 
        var returnValue = paraObj[paras.toLowerCase()]; 
        if(typeof(returnValue)=="undefined"){ 
        return ""; 
        }else{ 
        return returnValue; 
        } 
    }
    
 // 转换为数字
function intval(v)
{
 v = parseInt(v);
 return isNaN(v) ? 0 : v;
}   
   
// 获取元素信息
function getPos(e)
{
 var l = 0;
 var t  = 0;
 var w = intval(e.style.width);
 var h = intval(e.style.height);
 var wb = e.offsetWidth;
 var hb = e.offsetHeight;
 while (e.offsetParent){
  l += e.offsetLeft + (e.currentStyle?intval(e.currentStyle.borderLeftWidth):0);
  t += e.offsetTop  + (e.currentStyle?intval(e.currentStyle.borderTopWidth):0);
  e = e.offsetParent;
 }
 l += e.offsetLeft + (e.currentStyle?intval(e.currentStyle.borderLeftWidth):0);
 t  += e.offsetTop  + (e.currentStyle?intval(e.currentStyle.borderTopWidth):0);
 return {x:l, y:t, w:w, h:h, wb:wb, hb:hb};
}

// 获取滚动条信息
function getScroll() 
{
 var t, l, w, h;
 
 if (document.documentElement && document.documentElement.scrollTop) {
  t = document.documentElement.scrollTop;
  l = document.documentElement.scrollLeft;
  w = document.documentElement.scrollWidth;
  h = document.documentElement.scrollHeight;
 } else if (document.body) {
  t = document.body.scrollTop;
  l = document.body.scrollLeft;
  w = document.body.scrollWidth;
  h = document.body.scrollHeight;
 }
 return { t: t, l: l, w: w, h: h };
}

// 锚点(Anchor)间平滑跳转
function scroller(el, duration)
{
 if(typeof el != 'object') { el = document.getElementById(el); }

 if(!el) return;

 var z = this;
 z.el = el;
 z.p = getPos(el);
 z.s = getScroll();
 z.clear = function(){window.clearInterval(z.timer);z.timer=null};
 z.t=(new Date).getTime();

 z.step = function(){
  var t = (new Date).getTime();
  var p = (t - z.t) / duration;
  if (t >= duration + z.t) {
   z.clear();
   window.setTimeout(function(){z.scroll(z.p.y, z.p.x)},13);
  } else {
   st = ((-Math.cos(p*Math.PI)/2) + 0.5) * (z.p.y-z.s.t) + z.s.t;
   sl = ((-Math.cos(p*Math.PI)/2) + 0.5) * (z.p.x-z.s.l) + z.s.l;
   z.scroll(st, sl);
  }
 };
 z.scroll = function (t, l){window.scrollTo(l, t)};
 z.timer = window.setInterval(function(){z.step();},13);
}
