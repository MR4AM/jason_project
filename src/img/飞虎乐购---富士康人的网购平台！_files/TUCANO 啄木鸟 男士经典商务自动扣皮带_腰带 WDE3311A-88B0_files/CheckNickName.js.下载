/*
 * 验证用户是否登录，是否有昵称，保存用户昵称，跳转至相关页面
 * autor: xintong jianghai
 * Date: 2012-04-17
 * Revision:1.0
 */
 function getLength(str) {
    ///<summary>获得字符串实际长度，中文2，英文1</summary>
    ///<param name="str">要获得长度的字符串</param>
    var realLength = 0, len = str.length, charCode = -1;
    for (var i = 0; i < len; i++) {
        charCode = str.charCodeAt(i);
        if (charCode >= 0 && charCode <= 128) realLength += 1;
        else realLength += 2;
    }
    return realLength;
};

(function($){  
	$.fn.CheckNickName = function(fun){
	    $(this).click(function(e){
			var obj = $(this);
	        //验证是否登录
	        $.ajax({url:'/PublicAjax/CheckLogin.ashx?random='+Math.random(),dataType: "text",success: function(data){	
	           var json = eval('(' + data + ')');             
	           if(json.isLogin==false){//没有登录
	                var loaclUrl= window.location.href;	          
	                 self.location.href='/Pages/MemberCenter/Login.aspx?returnUrl='+loaclUrl;
    	       
	           }else{
	                $.ajax({url:'/PublicAjax/ValidateNeckName.ashx?type=0&productNo='+obj.attr("pro")+'&random='+Math.random(),dataType: "text",success: function(data){
	                    var json = eval('(' + data + ')');
	                     //进行用户是否购买过此商品的判断	               
	                    if(json.result==false && obj.attr("checkhasbuy")=="true"){
	                        var ominMVerify=new MinWin({obj:"#JNoBuyVerify",spaceName:"JNoBuyVerify"});
	                        ominMVerify.show();
	                        $("#miniWd_nobuy_close1").click(function(){
			                    $("#JNoBuyVerify").css("display","none");
			                });
			                return false;
			            }
			            else{
	                        //已登录用户
	                        $.ajax({url:'/PublicAjax/ValidateNeckName.ashx?type=1&random='+Math.random(),dataType: "text",success: function(data){
	                        var json = eval('(' + data + ')');
	                        //进行用户是否有昵称判断	               
	                        if(json.result==false){
	                              //如果用户没有昵称，进行新增昵称操作
	                              //弹出新增昵称层	                
	                             // $('body').load('/Pages/MemberCenter/NickNameApply.aspx');	                    
	                               if(null==$('#minWinNickName').html()||""==$('#minWinNickName').html()){
	                               //如果不存在弹出框，则进行append弹出框
                                     $.ajax({
                                            url: "/Pages/MemberCenter/NickNameApply.aspx",
                                            cache: false,
                                            dataType: "text",
                                            success: function(html){
                                            $('body').append(html);
                                            nickNameInputWinSet();//弹出昵称框可见 
                	                            
                                        //点击提交昵称事件	                            
	                                        $(".nickNameSubmitClass").click(function(){
							                    var reg=/^[a-zA-Z0-9\u4e00-\u9fa5]+$/;
							                    var inputNickName = $.trim($("#minWinNickNameInput").val()); 		
							                    var len = getLength(inputNickName);					               
						                        var is_match = reg.test(inputNickName);
							                    if(len>=6 && len<=18 && is_match){//验证为中文、英文以及数字									
											                    //$(".m_form_errhint").html("输入正确！"); 
											                    //$(this).addClass("m_form_input_sec"); 												 
										                      //提交昵称至后台   	                            
										                    $.ajax({
												                      url: "/PublicAjax/ValidateNeckName.ashx",//验证用户输入的昵称是否符合规范
												                      cache: false,
												                      data:{type:2,nickName:escape($('#minWinNickNameInput').val())},
												                      dataType: "text",
												                      success: function(json){
												                      var data = eval('(' + json + ')');                                                                              
													                    if(data.result==true){                                          
																                       $.ajax({
																		                      url: "/PublicAjax/UpdateNickName.ashx?nickName=" + escape($('#minWinNickNameInput').val()),
																		                      cache: false,
																		                      //data:{nickName:$('#minWinNickNameInput').val()},
																		                      dataType: "text",
																		                      success: function(json){
																		                      var data = eval('(' + json + ')');                                                               
																					                    if(data.result==true){                                                                            
																					                     $("#minWinNickName").hide();
																						                    var ominWin=$("#minWinNickNameSucc");
																						                    ominWin.show();
																						                    if($.browser.msie && Number($.browser.version) <= 6){
																								                    var doch=$(document).height();
																								                    ominWin.height(doch);
																								                    ominWinH2=parseInt(ominWin.children(".m_minWin").height()/2);
																								                    var owin=$(window);
																								                    var owinh2=parseInt(owin.height()/2);
																								                    ominWin.children(".m_minWin").css({"top":owin.scrollTop()+owinh2-ominWinH2});
																								                    owin.bind("scroll",function(){
																										                    var top=owin.scrollTop()+owinh2-ominWinH2;
																										                    ominWin.children(".m_minWin").css({"top":top});
																									                    });
																						                    }																						
																						                    ominWin.find(".m_minWin_close").bind("click",function(){
																									                    ominWin.hide();
																									                    //$(this).unbind(event);
																							                    });
																						                    ominWin.find(".btn_concell").bind("click",function(){
																								                    ominWin.hide();
																							                    //	$(this).unbind(event);
																						                    });
																						                    setTimeout(function(){ominWin.hide();},2000);
																						                     }else{//更新失败  
																						                      $(".m_form_errhint").html(data.replay).show();  
																						                     // $(this).removeClass("m_form_input_sec");   
																						                      $("#minWinNickNameInput").removeClass("m_form_input_sec"); //移除输出成功的样式                                                                           
																					                      }                                             
																		                    }
																	                     });     
														                      }else {
														                       $(".m_form_errhint").html(data.replay).show(); 														             
														                      // $(this).removeClass("m_form_input_sec"); 														             
														                       $("#minWinNickNameInput").removeClass("m_form_input_sec"); //移除输出成功的样式
        														               
														                      }                                   
													                    }
												                     })
									                       }else{ //验证为错误
									                         if(inputNickName.length>0){//输入验证为错误
									                            $(".m_form_errhint").html("输入错误！").show();      
											                   // $(this).removeClass("m_form_input_sec"); 
											                    $("#minWinNickNameInput").removeClass("m_form_input_sec"); //移除输出成功的样式
									                         }else{//不输入时提示填写昵称
									                            $(".m_form_errhint").html("请填写昵称！").show();      
                                                               // $(this).removeClass("m_form_input_sec"); 
                                                                $("#minWinNickNameInput").removeClass("m_form_input_sec"); //移除输出成功的样式
									                         }											             
									                       }   	 
                    										 
                                                    });                                                         
	                                         }
                                         }); 
	                               }else{
	                                 //已存在昵称框	                       
	                                 $(".m_form_errhint").html("昵称不可与用户名相同").show(); //将存在的弹出框提示设置初始值
	                                 $("#minWinNickNameInput").removeClass("m_form_input_sec"); //移除输出成功的样式
	                                 $("#minWinNickNameInput").val('');//将存在的弹出框输入设置为空 
	                                 nickNameInputWinSet();//显示昵称框
	                               }                                              	                
	                        }else{    
        	                         
	                            //用户已经存在昵称，进行页面跳转或者是调用service操作
	                            fun(obj);
	                        }
	                   }});
	                }
	             }});
	          }
	        }});
	    });	    
	}
})(jQuery);


function  nickNameInputWinSet(){
    var ominWin=$("#minWinNickName");
    ominWin.show();
    if($.browser.msie && Number($.browser.version) <= 6){
        var doch=$(document).height();
        ominWin.height(doch);
        ominWinH2=parseInt(ominWin.children(".m_minWin").height()/2);
        var owin=$(window);
        var owinh2=parseInt(owin.height()/2);
        ominWin.children(".m_minWin").css({"top":owin.scrollTop()+owinh2-ominWinH2});
        owin.bind("scroll",function(){
                var top=owin.scrollTop()+owinh2-ominWinH2;
                ominWin.children(".m_minWin").css({"top":top});
            });
    }
    
    ominWin.find(".m_minWin_close").bind("click",function(){
            ominWin.hide();
          //  $(this).unbind(event);
        });
    ominWin.find(".btn_concell").bind("click",function(){
            ominWin.hide();
         //   $(this).unbind(event);
        });
        
    
    $("#minWinNickNameInput").bind("change",function(){
            var othis = $(this);
            //只能输入中文、英文以及数字
            var inputNickName = $.trim(othis.val()); 
            var reg=/^[a-zA-Z0-9\u4e00-\u9fa5]+$/;
            var len = getLength(inputNickName);	
            var is_match = reg.test(inputNickName);
						                
            if(inputNickName!="" && len>=6 && len<=18 && is_match){
                //othis.next(".m_form_errhint").hide();
                 othis.addClass("m_form_input_sec");
                $("#minWinNickNamebtn").removeClass("m_form_btn_disabled");
            }else{
               // othis.removeClass("m_form_input_sec");
             //   $("#minWinNickNamebtn").addClass("m_form_btn_disabled");
            }
    });
    if($("#minWinNickNameInput").val("")){
      $("#minWinNickNamebtn").addClass("m_form_btn_disabled");   
    }



}



















